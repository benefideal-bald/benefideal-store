<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã –±–µ–∑ –¥–µ–Ω–µ–≥ ‚Äì Benefideal</title>
    <link rel="stylesheet" href="styles.css?v=2.0">
    <style>
        .check-container {
            max-width: 700px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .status.success {
            background: #d4edda;
            border-color: #28a745;
        }
        .status.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .status.info {
            background: #e7f3ff;
            border-color: #007bff;
        }
        .status.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .code-block {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            margin-top: 1rem;
            word-break: break-all;
            white-space: pre-wrap;
        }
        .btn-check {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="nav">
                <a href="index.html" class="logo">Benefideal</a>
            </div>
        </div>
    </header>

    <main class="product-page" style="padding: var(--space-24) 0;">
        <div class="check-container">
            <h1 style="margin-bottom: var(--space-6);">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã)</h1>
            
            <div class="status info">
                <strong>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç:</strong><br>
                ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ª–∏ CardLink<br>
                ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π<br>
                ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ callback (—Å–∏–º—É–ª—è—Ü–∏—è)<br>
                ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–∏ –∑–∞–∫–∞–∑—ã<br>
                <strong>–ë–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã!</strong>
            </div>
            
            <button id="checkBtn" class="btn btn-primary btn-check" onclick="checkPayment()">
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É
            </button>
            
            <div id="results"></div>
        </div>
    </main>

    <script>
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const apiBase = isLocalhost ? 'http://localhost:3000' : window.location.origin;

        async function checkPayment() {
            const btn = document.getElementById('checkBtn');
            const results = document.getElementById('results');
            
            btn.disabled = true;
            btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            results.innerHTML = '<div class="status info">‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...</div>';
            
            const checks = [];
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            try {
                const configRes = await fetch(`${apiBase}/api/cardlink/check-config`);
                const config = await configRes.json();
                
                if (config.configured) {
                    checks.push({
                        title: '‚úÖ CardLink –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
                        status: 'success',
                        details: '–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ'
                    });
                } else {
                    checks.push({
                        title: '‚ùå CardLink –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
                        status: 'error',
                        details: '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ CARDLINK_SHOP_ID –∏ CARDLINK_API_TOKEN –Ω–∞ Railway'
                    });
                }
            } catch (error) {
                checks.push({
                    title: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏',
                    status: 'error',
                    details: error.message
                });
            }
            
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (—Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å)
            try {
                const testOrderId = 'TEST_CHECK_' + Date.now();
                const testData = {
                    name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    email: 'test@example.com',
                    cart: [{ id: 1, title: '–¢–µ—Å—Ç', price: 10, quantity: 1, months: 1 }],
                    orderId: testOrderId
                };
                
                const paymentRes = await fetch(`${apiBase}/api/cardlink/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const paymentResult = await paymentRes.json();
                
                if (paymentResult.success && paymentResult.payment_url) {
                    checks.push({
                        title: '‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç',
                        status: 'success',
                        details: 'API CardLink –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ'
                    });
                    
                    // 3. –°–∏–º—É–ª—è—Ü–∏—è callback (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã)
                    try {
                        const callbackRes = await fetch(`${apiBase}/api/cardlink/test-callback`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ orderId: testOrderId })
                        });
                        
                        const callbackResult = await callbackRes.json();
                        
                        if (callbackResult.success) {
                            checks.push({
                                title: '‚úÖ Callback —Ä–∞–±–æ—Ç–∞–µ—Ç',
                                status: 'success',
                                details: '–°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏'
                            });
                        } else {
                            checks.push({
                                title: '‚ö†Ô∏è Callback —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏',
                                status: 'warning',
                                details: 'Callback endpoint –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –Ω—É–∂–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏'
                            });
                        }
                    } catch (callbackError) {
                        checks.push({
                            title: '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å callback',
                            status: 'warning',
                            details: 'Endpoint –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –Ω—É–∂–Ω–∞ —Ä–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏'
                        });
                    }
                } else if (paymentResult.error && paymentResult.error.includes('–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω')) {
                    checks.push({
                        title: '‚ùå CardLink –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
                        status: 'error',
                        details: paymentResult.error
                    });
                } else {
                    checks.push({
                        title: '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞',
                        status: 'error',
                        details: paymentResult.error || JSON.stringify(paymentResult)
                    });
                }
            } catch (error) {
                checks.push({
                    title: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞',
                    status: 'error',
                    details: error.message
                });
            }
            
            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ callback endpoint
            try {
                const callbackCheckRes = await fetch(`${apiBase}/api/cardlink/callback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'SUCCESS', order_id: 'TEST' })
                });
                
                const callbackCheck = await callbackCheckRes.json();
                
                checks.push({
                    title: '‚úÖ Callback endpoint –¥–æ—Å—Ç—É–ø–µ–Ω',
                    status: 'success',
                    details: 'Endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã'
                });
            } catch (error) {
                checks.push({
                    title: '‚ùå Callback endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                    status: 'error',
                    details: error.message
                });
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            let html = '';
            checks.forEach(check => {
                html += `
                    <div class="status ${check.status}">
                        <strong>${check.title}</strong><br>
                        ${check.details}
                    </div>
                `;
            });
            
            // –ò—Ç–æ–≥
            const successCount = checks.filter(c => c.status === 'success').length;
            const errorCount = checks.filter(c => c.status === 'error').length;
            const warningCount = checks.filter(c => c.status === 'warning').length;
            
            html += `
                <div class="status ${errorCount === 0 ? 'success' : 'error'}" style="margin-top: 2rem;">
                    <strong>üìä –ò—Ç–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:</strong><br>
                    ‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}<br>
                    ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${warningCount}<br>
                    ‚ùå –û—à–∏–±–∫–∏: ${errorCount}
                </div>
            `;
            
            if (errorCount === 0 && successCount >= 3) {
                html += `
                    <div class="status success" style="margin-top: 1rem;">
                        <strong>‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏!</strong><br>
                        –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã. –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏—Ç –∑–∞–∫–∞–∑, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:<br>
                        ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç –∑–∞–∫–∞–∑ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö<br>
                        ‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram<br>
                        ‚Ä¢ –°–æ–∑–¥–∞—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
                    </div>
                `;
            } else if (errorCount > 0) {
                html += `
                    <div class="status error" style="margin-top: 1rem;">
                        <strong>‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã!</strong><br>
                        –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –º–æ–≥–ª–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏.
                    </div>
                `;
            }
            
            results.innerHTML = html;
            btn.disabled = false;
            btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞';
        }
    </script>
</body>
</html>

