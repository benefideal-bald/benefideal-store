<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã CardLink ‚Äì Benefideal</title>
    <link rel="stylesheet" href="styles.css?v=2.0">
    <style>
        .check-item {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .check-item.success {
            background: #d4edda;
            border-color: #28a745;
        }
        .check-item.error {
            background: #f8d7da;
            border-color: #dc3545;
        }
        .check-item.warning {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .check-item.loading {
            background: #e7f3ff;
            border-color: #007bff;
        }
        .check-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .check-details {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        .check-code {
            background: #f5f5f5;
            padding: 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="nav">
                <a href="index.html" class="logo">Benefideal</a>
            </div>
        </div>
    </header>

    <main class="product-page" style="padding: var(--space-24) 0;">
        <div class="container" style="max-width: 800px;">
            <h1 style="margin-bottom: var(--space-6);">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã CardLink</h1>
            
            <div id="checks">
                <div class="check-item loading">
                    <div class="check-title">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const apiBase = isLocalhost ? 'http://localhost:3000' : window.location.origin;

        async function checkPayment() {
            const checks = [];
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
            checks.push(checkCreatePaymentEndpoint());
            
            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ callback endpoint
            checks.push(checkCallbackEndpoint());
            
            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ CardLink
            checks.push(checkCardLinkConfig());
            
            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏
            checks.push(checkPaymentPages());
            
            // 5. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã)
            checks.push(testPaymentCreation());
            
            const results = await Promise.all(checks);
            displayResults(results);
        }

        async function checkCreatePaymentEndpoint() {
            try {
                const response = await fetch(`${apiBase}/api/cardlink/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Test',
                        email: 'test@test.com',
                        cart: [{ id: 1, title: 'Test', price: 100, quantity: 1 }],
                        orderId: 'TEST_' + Date.now()
                    })
                });
                
                const data = await response.json();
                
                if (data.error && data.error.includes('–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω')) {
                    return {
                        title: '‚ùå CardLink –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
                        status: 'error',
                        details: '–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è CARDLINK_SHOP_ID –∏ CARDLINK_API_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ Railway',
                        code: data.error
                    };
                }
                
                if (data.success && data.payment_url) {
                    return {
                        title: '‚úÖ Endpoint —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç',
                        status: 'success',
                        details: '–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
                        code: `Payment URL: ${data.payment_url.substring(0, 50)}...`
                    };
                }
                
                if (data.error) {
                    return {
                        title: '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞',
                        status: 'warning',
                        details: 'Endpoint –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∞',
                        code: JSON.stringify(data, null, 2)
                    };
                }
                
                return {
                    title: '‚ùì –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç',
                    status: 'warning',
                    details: 'Endpoint –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π',
                    code: JSON.stringify(data, null, 2)
                };
            } catch (error) {
                return {
                    title: '‚ùå Endpoint —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                    status: 'error',
                    details: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É',
                    code: error.message
                };
            }
        }

        async function checkCallbackEndpoint() {
            try {
                const response = await fetch(`${apiBase}/api/cardlink/callback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'SUCCESS',
                        order_id: 'TEST',
                        amount: 100
                    })
                });
                
                const data = await response.json();
                
                return {
                    title: '‚úÖ Callback endpoint –¥–æ—Å—Ç—É–ø–µ–Ω',
                    status: 'success',
                    details: 'Endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã',
                    code: `Response: ${JSON.stringify(data)}`
                };
            } catch (error) {
                return {
                    title: '‚ùå Callback endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω',
                    status: 'error',
                    details: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É',
                    code: error.message
                };
            }
        }

        async function checkCardLinkConfig() {
            try {
                const response = await fetch(`${apiBase}/api/cardlink/check-config`);
                const data = await response.json();
                
                if (data.configured) {
                    return {
                        title: '‚úÖ CardLink –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ',
                        status: 'success',
                        details: '–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã',
                        code: `Shop ID: ${data.config.shop_id_configured ? '‚úÖ' : '‚ùå'}\nAPI Token: ${data.config.api_token_configured ? '‚úÖ' : '‚ùå'}\nCallback URL: ${data.config.callback_url}`
                    };
                } else {
                    return {
                        title: '‚ùå CardLink –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω',
                        status: 'error',
                        details: '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ Railway',
                        code: `Shop ID: ${data.config.shop_id_configured ? '‚úÖ' : '‚ùå –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}\nAPI Token: ${data.config.api_token_configured ? '‚úÖ' : '‚ùå –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}\n\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ CARDLINK_SHOP_ID –∏ CARDLINK_API_TOKEN –Ω–∞ Railway`
                    };
                }
            } catch (error) {
                return {
                    title: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é',
                    status: 'error',
                    details: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É',
                    code: error.message
                };
            }
        }

        async function checkPaymentPages() {
            const pages = [
                { name: 'payment-success.html', url: 'payment-success.html' },
                { name: 'payment-fail.html', url: 'payment-fail.html' }
            ];
            
            const results = [];
            for (const page of pages) {
                try {
                    const response = await fetch(page.url, { method: 'HEAD' });
                    if (response.ok) {
                        results.push(`‚úÖ ${page.name} –¥–æ—Å—Ç—É–ø–Ω–∞`);
                    } else {
                        results.push(`‚ùå ${page.name} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (${response.status})`);
                    }
                } catch (error) {
                    results.push(`‚ùå ${page.name} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞`);
                }
            }
            
            const allOk = results.every(r => r.startsWith('‚úÖ'));
            
            return {
                title: allOk ? '‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã' : '‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã',
                status: allOk ? 'success' : 'warning',
                details: results.join(', '),
                code: ''
            };
        }

        async function testPaymentCreation() {
            try {
                const testData = {
                    name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    email: 'test@example.com',
                    cart: [
                        { id: 1, title: 'ChatGPT Plus', price: 1990, quantity: 1, months: 1 }
                    ],
                    orderId: 'TEST_CHECK_' + Date.now()
                };
                
                const response = await fetch(`${apiBase}/api/cardlink/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (data.success && data.payment_url) {
                    return {
                        title: '‚úÖ –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —É—Å–ø–µ—à–µ–Ω',
                        status: 'success',
                        details: '–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω, –Ω–æ –ù–ï –æ–ø–ª–∞—á–µ–Ω (—ç—Ç–æ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç)',
                        code: `Order ID: ${testData.orderId}\nPayment URL: ${data.payment_url.substring(0, 80)}...`
                    };
                }
                
                if (data.error) {
                    return {
                        title: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞',
                        status: 'error',
                        details: data.error,
                        code: JSON.stringify(data, null, 2)
                    };
                }
                
                return {
                    title: '‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ —Ç–µ—Å—Ç–µ',
                    status: 'warning',
                    details: '–ü–ª–∞—Ç–µ–∂ –Ω–µ —Å–æ–∑–¥–∞–Ω, –Ω–æ –ø—Ä–∏—á–∏–Ω–∞ –Ω–µ—è—Å–Ω–∞',
                    code: JSON.stringify(data, null, 2)
                };
            } catch (error) {
                return {
                    title: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞',
                    status: 'error',
                    details: '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç',
                    code: error.message
                };
            }
        }

        function displayResults(results) {
            const container = document.getElementById('checks');
            container.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `check-item ${result.status}`;
                div.innerHTML = `
                    <div class="check-title">${result.title}</div>
                    <div class="check-details">${result.details}</div>
                    ${result.code ? `<div class="check-code">${result.code}</div>` : ''}
                `;
                container.appendChild(div);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            const warningCount = results.filter(r => r.status === 'warning').length;
            
            const summary = document.createElement('div');
            summary.className = 'check-item';
            summary.style.marginTop = '2rem';
            summary.innerHTML = `
                <div class="check-title">üìä –ò—Ç–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
                <div class="check-details">
                    ‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}<br>
                    ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: ${warningCount}<br>
                    ‚ùå –û—à–∏–±–∫–∏: ${errorCount}
                </div>
                ${errorCount > 0 ? `
                    <div class="check-details" style="margin-top: 1rem; color: #dc3545;">
                        <strong>‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï:</strong> –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CardLink –Ω–∞ Railway:
                        <ul style="margin-top: 0.5rem;">
                            <li>CARDLINK_SHOP_ID - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</li>
                            <li>CARDLINK_API_TOKEN - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</li>
                            <li>CARDLINK_API_URL - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://cardlink.link/api/v1/bill/create)</li>
                        </ul>
                        <p style="margin-top: 0.5rem;">–¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ CardLink —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Callback URL: <code>https://benefideal.ru/api/cardlink/callback</code></p>
                    </div>
                ` : ''}
            `;
            container.appendChild(summary);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        checkPayment();
    </script>
</body>
</html>

