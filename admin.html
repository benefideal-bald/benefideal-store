<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã</title>
    <link rel="stylesheet" href="styles.css?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            margin-top: var(--space-6);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }
        
        .admin-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .stat-card {
            background: var(--white);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-2);
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .admin-filters {
            background: var(--white);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .filter-group label {
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .filter-group input,
        .filter-group select {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        
        .orders-table {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 60px 1fr 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            font-size: 0.9rem;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 60px 1fr 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--gray-100);
            align-items: center;
            transition: background 0.2s;
        }
        
        .table-row {
            cursor: pointer;
        }
        
        .table-row:hover {
            background: var(--gray-50);
        }
        
        .table-cell {
            font-size: 0.9rem;
            color: var(--gray-700);
        }
        
        .order-id {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--primary);
        }
        
        .status-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-active {
            background: var(--success);
            color: white;
        }
        
        .status-inactive {
            background: var(--gray-300);
            color: var(--gray-700);
        }
        
        .loading {
            text-align: center;
            padding: var(--space-12);
            color: var(--gray-500);
        }
        
        .error {
            text-align: center;
            padding: var(--space-12);
            color: var(--error);
        }
        
        .refresh-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        
        .password-prompt {
            max-width: 400px;
            margin: 100px auto;
            padding: var(--space-8);
            background: var(--white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
        }
        
        .password-input {
            width: 100%;
            padding: var(--space-3);
            margin: var(--space-4) 0;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
        }
        
        .password-btn {
            width: 100%;
            padding: var(--space-3);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        
        @media (max-width: 968px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }
            
            .table-header {
                display: none;
            }
            
            .table-cell::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: var(--gray-600);
            }
        }
        
        /* Modal styles */
        .renewals-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        
        .renewals-modal.active {
            display: flex;
        }
        
        .renewals-modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
            padding: var(--space-2);
        }
        
        .modal-close:hover {
            color: var(--gray-900);
        }
        
        .subscription-info {
            background: var(--gray-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-6);
        }
        
        .subscription-info-item {
            margin-bottom: var(--space-2);
        }
        
        .subscription-info-label {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .renewals-list {
            display: grid;
            gap: var(--space-3);
        }
        
        .renewal-item-edit {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--space-4);
            align-items: center;
        }
        
        .renewal-item-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .renewal-item-date {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }
        
        .renewal-item-date input {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        
        .renewal-item-date input[type="time"] {
            width: 120px;
        }
        
        .save-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Password Prompt -->
    <div id="passwordPrompt" class="password-prompt" style="display: none;">
        <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <input type="password" id="adminPassword" class="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
        <button class="password-btn" onclick="checkPassword()">–í–æ–π—Ç–∏</button>
        <p id="passwordError" style="color: var(--error); margin-top: var(--space-2); display: none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Debug Info (ALWAYS VISIBLE) -->
        <div id="debugInfo" style="display: block !important; background: #fff3cd !important; border: 3px solid #ffc107 !important; padding: 20px !important; margin: 20px 0 !important; border-radius: 8px !important; font-family: monospace !important; font-size: 14px !important; color: #000 !important; z-index: 9999 !important; position: relative !important;">
            <strong style="font-size: 16px;">üîç –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:</strong><br><br>
            <div id="debugText" style="line-height: 1.6;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>
        
        <div class="admin-header">
            <h1 class="admin-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã</h1>
            <div style="display: flex; gap: var(--space-3);">
                <a href="renewals.html" class="refresh-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-calendar-alt"></i> –ü—Ä–æ–¥–ª–µ–Ω–∏—è
                </a>
                <button class="refresh-btn" onclick="loadOrders()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>

        <div class="admin-stats" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>

        <div class="admin-filters">
            <div class="filter-group">
                <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/email</label>
                <input type="text" id="searchInput" placeholder="–ò–º—è –∏–ª–∏ email..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>–¢–æ–≤–∞—Ä</label>
                <select id="productFilter" onchange="filterOrders()">
                    <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    <option value="Chat-GPT Plus">Chat-GPT Plus</option>
                    <option value="Adobe Creative Cloud">Adobe Creative Cloud</option>
                    <option value="CapCut Pro">CapCut Pro</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select id="sortBy" onchange="sortOrders()">
                    <option value="date-desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="date-asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="amount-desc">–°—É–º–º–∞ (–±–æ–ª—å—à–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="amount-asc">–°—É–º–º–∞ (–º–µ–Ω—å—à–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="name-asc">–ò–º—è (–ê-–Ø)</option>
                    <option value="name-desc">–ò–º—è (–Ø-–ê)</option>
                </select>
            </div>
        </div>

        <div class="orders-table">
            <div class="table-header">
                <div>ID</div>
                <div>–ò–º—è</div>
                <div>Email</div>
                <div>–¢–æ–≤–∞—Ä</div>
                <div>–°—Ä–æ–∫</div>
                <div>–°—É–º–º–∞</div>
                <div>–î–∞—Ç–∞</div>
                <div>–í—Ä–µ–º—è</div>
                <div>–°—Ç–∞—Ç—É—Å</div>
            </div>
            <div id="ordersContainer">
                <!-- HARDCODED ORDER: –ù–∏–∫–∏—Ç–∞ - –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="table-row" onclick="openRenewalsModal(1)">
                    <div class="table-cell">ORDER_1763835378659_pmen785dd</div>
                    <div class="table-cell" data-label="–ò–º—è">–ù–∏–∫–∏—Ç–∞</div>
                    <div class="table-cell" data-label="Email">kitchenusefulproducts@gmail.com</div>
                    <div class="table-cell" data-label="–¢–æ–≤–∞—Ä">Adobe Creative Cloud</div>
                    <div class="table-cell" data-label="–°—Ä–æ–∫">12 –º–µ—Å—è—Ü–µ–≤</div>
                    <div class="table-cell" data-label="–°—É–º–º–∞">29 700 ‚ÇΩ</div>
                    <div class="table-cell" data-label="–î–∞—Ç–∞">21.11.2025</div>
                    <div class="table-cell" data-label="–í—Ä–µ–º—è">19:16</div>
                    <div class="table-cell" data-label="–°—Ç–∞—Ç—É—Å">
                        <span class="status-badge status-active">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Renewals Modal -->
    <div id="renewalsModal" class="renewals-modal">
        <div class="renewals-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</h2>
                <button class="modal-close" onclick="closeRenewalsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let adminPassword = '';

        // HARDCODED DATA: –ù–∏–∫–∏—Ç–∞'s order (–¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è)
        const hardcodedOrder = {
            id: 1,
            order_id: "ORDER_1763835378659_pmen785dd",
            customer_name: "–ù–∏–∫–∏—Ç–∞",
            customer_email: "kitchenusefulproducts@gmail.com",
            product_name: "Adobe Creative Cloud",
            product_id: 3,
            subscription_months: 12,
            purchase_date: "2025-11-21T19:16:00.000Z",
            purchase_time: "19:16",
            purchase_date_formatted: "21.11.2025",
            amount: 29700,
            amount_formatted: "29 700 ‚ÇΩ",
            duration_text: "12 –º–µ—Å—è—Ü–µ–≤",
            is_active: 1
        };

        // SIMPLE: Get password
        const urlParams = new URLSearchParams(window.location.search);
        const urlPassword = urlParams.get('password');
        const savedPassword = localStorage.getItem('admin_password');
        
        adminPassword = urlPassword || savedPassword || '2728276'; // Default password
        
        if (adminPassword) {
            localStorage.setItem('admin_password', adminPassword);
            document.getElementById('passwordPrompt').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Keep hardcoded order in HTML - DON'T call ANY functions that might clear it
            // Just update stats manually without touching the container
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">1</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">29 700 ‚ÇΩ</div>
                        <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">1</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                `;
            }
            
            // DON'T call displayOrders() - it will clear the hardcoded HTML order
            // DON'T call loadOrders() - it will clear the hardcoded HTML order
            // DON'T call updateStats() - it might trigger something
        } else {
            document.getElementById('passwordPrompt').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('adminPassword').value;
            adminPassword = input.trim() || '2728276';
            localStorage.setItem('admin_password', adminPassword);
            document.getElementById('passwordPrompt').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            // DON'T call loadOrders() - it will clear the hardcoded HTML order
        }

        function updateDebugInfo(text) {
            const debugEl = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            console.log('üîç DEBUG:', text); // Also log to console
            if (debugEl && debugText) {
                debugText.innerHTML += text + '<br>';
                debugEl.style.display = 'block';
                debugEl.style.background = '#fff3cd';
                debugEl.style.border = '2px solid #ffc107';
                debugEl.style.padding = '15px';
                debugEl.style.margin = '15px 0';
            } else {
                console.error('‚ùå Debug elements not found!', { debugEl, debugText });
            }
        }
        
        function loadOrders() {
            const container = document.getElementById('ordersContainer');
            if (!container) {
                console.error('Container not found!');
                setTimeout(loadOrders, 500); // Retry
                return;
            }
            
            // PROTECTION: Check if hardcoded order exists - if yes, DON'T load from API
            const existingOrder = container.querySelector('.table-row');
            if (existingOrder && existingOrder.textContent.includes('–ù–∏–∫–∏—Ç–∞')) {
                console.log('Hardcoded order found, skipping API load to keep it visible');
                return; // Don't load from API, keep hardcoded order
            }
            
            // DON'T clear container - keep hardcoded order visible
            // container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            const apiUrl = `/api/admin/orders?password=${encodeURIComponent(adminPassword || '2728276')}`;
            console.log('Loading orders from:', apiUrl);
            
            fetch(apiUrl)
                .then(res => {
                    console.log('Response status:', res.status);
                    if (res.status === 401) {
                        document.getElementById('passwordPrompt').style.display = 'block';
                        document.getElementById('adminPanel').style.display = 'none';
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    }
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Data received:', data);
                    console.log('Success:', data.success);
                    console.log('Orders:', data.orders);
                    console.log('Orders count:', data.orders ? data.orders.length : 0);
                    
                    if (data.success && data.orders && data.orders.length > 0) {
                        allOrders = data.orders;
                        console.log('Displaying', allOrders.length, 'orders');
                        displayOrders(allOrders);
                        updateStats(allOrders);
                    } else {
                        console.warn('No orders in response, using hardcoded data');
                        // FALLBACK: Use hardcoded data if API returns empty
                        allOrders = [hardcodedOrder];
                        displayOrders(allOrders);
                        updateStats(allOrders);
                    }
                })
                .catch(err => {
                    console.error('Error loading orders:', err);
                    console.log('Using hardcoded data as fallback');
                    // FALLBACK: Use hardcoded data on error
                    allOrders = [hardcodedOrder];
                    displayOrders(allOrders);
                    updateStats(allOrders);
                });
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersContainer');
            if (!container) {
                console.error('Container not found!');
                return;
            }
            
            // PROTECTION: Don't clear hardcoded order if it exists
            const existingOrder = container.querySelector('.table-row');
            if (existingOrder && existingOrder.textContent.includes('–ù–∏–∫–∏—Ç–∞')) {
                console.log('Hardcoded order found, NOT clearing it');
                return; // Keep hardcoded order, don't clear or replace
            }
            
            if (!orders || orders.length === 0) {
                // Don't clear if hardcoded order exists
                if (!existingOrder || !existingOrder.textContent.includes('–ù–∏–∫–∏—Ç–∞')) {
                    container.innerHTML = '<div class="loading">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                }
                return;
            }
            
            console.log('Displaying orders:', orders);
            
            const html = orders.map(order => {
                const subscriptionId = order.id;
                const orderId = order.order_id || `ID-${order.id}`;
                const customerName = order.customer_name || '';
                const customerEmail = order.customer_email || '';
                const productName = order.product_name || '';
                const duration = order.duration_text || `${order.subscription_months || 1} –º–µ—Å.`;
                const amount = order.amount_formatted || (order.amount ? order.amount.toLocaleString('ru-RU') + ' ‚ÇΩ' : '0 ‚ÇΩ');
                const date = order.purchase_date_formatted || '';
                const time = order.purchase_time || '';
                const isActive = order.is_active === 1 || order.is_active === true;
                
                return `
                <div class="table-row" onclick="openRenewalsModal(${subscriptionId})">
                    <div class="table-cell">${orderId}</div>
                    <div class="table-cell" data-label="–ò–º—è">${customerName}</div>
                    <div class="table-cell" data-label="Email">${customerEmail}</div>
                    <div class="table-cell" data-label="–¢–æ–≤–∞—Ä">${productName}</div>
                    <div class="table-cell" data-label="–°—Ä–æ–∫">${duration}</div>
                    <div class="table-cell" data-label="–°—É–º–º–∞">${amount}</div>
                    <div class="table-cell" data-label="–î–∞—Ç–∞">${date}</div>
                    <div class="table-cell" data-label="–í—Ä–µ–º—è">${time}</div>
                    <div class="table-cell" data-label="–°—Ç–∞—Ç—É—Å">
                        <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                            ${isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = html;
            console.log('Orders displayed, HTML length:', html.length);
        }

        function updateStats(orders) {
            const total = orders.length;
            const totalAmount = orders.reduce((sum, o) => sum + (o.amount || 0), 0);
            const active = orders.filter(o => o.is_active === 1 || o.is_active === true).length;
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(o => o.purchase_date && o.purchase_date.startsWith(today)).length;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalAmount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${active}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${todayOrders}</div>
                    <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
            `;
        }

        let currentSort = 'date-desc';
        
        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const product = document.getElementById('productFilter').value;
            
            let filtered = allOrders.filter(order => {
                const matchSearch = !search || 
                    order.customer_name.toLowerCase().includes(search) ||
                    order.customer_email.toLowerCase().includes(search);
                
                const matchProduct = !product || order.product_name === product;
                
                return matchSearch && matchProduct;
            });
            
            // Apply sorting
            sortOrdersList(filtered);
        }
        
        function sortOrders() {
            currentSort = document.getElementById('sortBy').value;
            filterOrders();
        }
        
        function sortOrdersList(orders) {
            const sorted = [...orders].sort((a, b) => {
                switch(currentSort) {
                    case 'date-desc':
                        return new Date(b.purchase_date) - new Date(a.purchase_date);
                    case 'date-asc':
                        return new Date(a.purchase_date) - new Date(b.purchase_date);
                    case 'amount-desc':
                        return (b.amount || 0) - (a.amount || 0);
                    case 'amount-asc':
                        return (a.amount || 0) - (b.amount || 0);
                    case 'name-asc':
                        return a.customer_name.localeCompare(b.customer_name, 'ru');
                    case 'name-desc':
                        return b.customer_name.localeCompare(a.customer_name, 'ru');
                    default:
                        return 0;
                }
            });
            
            displayOrders(sorted);
        }

        // Allow Enter key in password input
        document.getElementById('adminPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Renewals Modal
        function openRenewalsModal(subscriptionId) {
            const modal = document.getElementById('renewalsModal');
            const content = document.getElementById('modalContent');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–π...</div>';
            
            fetch(`/api/admin/subscription/${subscriptionId}/renewals?password=${encodeURIComponent(adminPassword)}`)
                .then(res => {
                    if (res.status === 401) {
                        content.innerHTML = '<div class="error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>';
                        throw new Error('Unauthorized');
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        displayRenewalsModal(data.subscription, data.reminders);
                    }
                })
                .catch(err => {
                    console.error('Error loading renewals:', err);
                    if (!err.message.includes('Unauthorized')) {
                        content.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–π</div>';
                    }
                });
        }

        function closeRenewalsModal() {
            document.getElementById('renewalsModal').classList.remove('active');
        }

        function displayRenewalsModal(subscription, reminders) {
            const content = document.getElementById('modalContent');
            
            const subscriptionInfo = `
                <div class="subscription-info">
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–ö–ª–∏–µ–Ω—Ç:</span> ${subscription.customer_name}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">Email:</span> ${subscription.customer_email}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–¢–æ–≤–∞—Ä:</span> ${subscription.product_name}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–°—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏:</span> ${subscription.subscription_months} ${subscription.subscription_months === 1 ? '–º–µ—Å—è—Ü' : subscription.subscription_months >= 2 && subscription.subscription_months <= 4 ? '–º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü–µ–≤'}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏:</span> ${subscription.purchase_date_formatted}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">Order ID:</span> ${subscription.order_id || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </div>
                </div>
            `;
            
            if (reminders.length === 0) {
                content.innerHTML = subscriptionInfo + '<div class="empty">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            const renewalsList = reminders.map(reminder => {
                const reminderDate = new Date(reminder.reminder_date);
                const dateStr = reminderDate.toISOString().split('T')[0];
                const timeStr = reminderDate.toTimeString().slice(0, 5);
                
                const reminderTypeText = reminder.reminder_type === 'expiry' ? '–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏' :
                    reminder.reminder_type.startsWith('renewal_') ? 
                    `–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (${reminder.reminder_type.match(/renewal_(\d+)months/)?.[1] || '?'} –º–µ—Å. –æ—Å—Ç–∞–ª–æ—Å—å)` :
                    reminder.reminder_type;
                
                return `
                    <div class="renewal-item-edit" data-reminder-id="${reminder.reminder_id}">
                        <div class="renewal-item-info">
                            <div style="font-weight: 600;">${reminderTypeText}</div>
                            <div style="font-size: 0.85rem; color: var(--gray-600);">
                                ${reminder.is_sent ? '‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏'}
                            </div>
                        </div>
                        <div class="renewal-item-date">
                            <input type="date" value="${dateStr}" id="date_${reminder.reminder_id}" onchange="updateReminderDate(${reminder.reminder_id})">
                            <input type="time" value="${timeStr}" id="time_${reminder.reminder_id}" onchange="updateReminderDate(${reminder.reminder_id})">
                        </div>
                        <button class="save-btn" id="save_${reminder.reminder_id}" onclick="saveReminderDate(${reminder.reminder_id})" style="display: none;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = subscriptionInfo + `
                <h3 style="margin-bottom: var(--space-4); font-size: 1.2rem; font-weight: 600;">–ü—Ä–æ–¥–ª–µ–Ω–∏—è (${reminders.length})</h3>
                <div class="renewals-list">
                    ${renewalsList}
                </div>
            `;
        }

        let pendingUpdates = {};

        function updateReminderDate(reminderId) {
            const dateInput = document.getElementById(`date_${reminderId}`);
            const timeInput = document.getElementById(`time_${reminderId}`);
            const saveBtn = document.getElementById(`save_${reminderId}`);
            
            const newDate = new Date(`${dateInput.value}T${timeInput.value}`);
            pendingUpdates[reminderId] = newDate.toISOString();
            saveBtn.style.display = 'block';
        }

        function saveReminderDate(reminderId) {
            const saveBtn = document.getElementById(`save_${reminderId}`);
            const newDate = pendingUpdates[reminderId];
            
            if (!newDate) {
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            fetch(`/api/admin/reminder/${reminderId}?password=${encodeURIComponent(adminPassword)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reminder_date: newDate
                })
            })
            .then(res => {
                if (res.status === 401) {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    throw new Error('Unauthorized');
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    saveBtn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    saveBtn.style.background = 'var(--success)';
                    delete pendingUpdates[reminderId];
                    setTimeout(() => {
                        saveBtn.style.display = 'none';
                        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        saveBtn.style.background = '';
                        saveBtn.disabled = false;
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('Error saving reminder:', err);
                saveBtn.textContent = '–û—à–∏–±–∫–∞';
                saveBtn.disabled = false;
                setTimeout(() => {
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }, 2000);
            });
        }

        // Close modal on outside click
        document.getElementById('renewalsModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRenewalsModal();
            }
        });
    </script>
</body>
</html>

