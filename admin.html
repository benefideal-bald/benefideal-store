<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã</title>
    <link rel="stylesheet" href="styles.css?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            margin-top: var(--space-6);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }
        
        .admin-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .stat-card {
            background: var(--white);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-2);
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .admin-filters {
            background: var(--white);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .filter-group label {
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .filter-group input,
        .filter-group select {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        
        .orders-table {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 60px 1fr 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            font-size: 0.9rem;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 60px 1fr 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--gray-100);
            align-items: center;
            transition: background 0.2s;
        }
        
        .table-row {
            cursor: pointer;
        }
        
        .table-row:hover {
            background: var(--gray-50);
        }
        
        .table-cell {
            font-size: 0.9rem;
            color: var(--gray-700);
        }
        
        .order-id {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--primary);
        }
        
        .status-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-active {
            background: var(--success);
            color: white;
        }
        
        .status-inactive {
            background: var(--gray-300);
            color: var(--gray-700);
        }
        
        .loading {
            text-align: center;
            padding: var(--space-12);
            color: var(--gray-500);
        }
        
        .error {
            text-align: center;
            padding: var(--space-12);
            color: var(--error);
        }
        
        .refresh-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        
        .password-prompt {
            max-width: 400px;
            margin: 100px auto;
            padding: var(--space-8);
            background: var(--white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
        }
        
        .password-input {
            width: 100%;
            padding: var(--space-3);
            margin: var(--space-4) 0;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
        }
        
        .password-btn {
            width: 100%;
            padding: var(--space-3);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        
        @media (max-width: 968px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }
            
            .table-header {
                display: none;
            }
            
            .table-cell::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: var(--gray-600);
            }
        }
        
        /* Modal styles */
        .renewals-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        
        .renewals-modal.active {
            display: flex;
        }
        
        .renewals-modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
            padding: var(--space-2);
        }
        
        .modal-close:hover {
            color: var(--gray-900);
        }
        
        .subscription-info {
            background: var(--gray-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-6);
        }
        
        .subscription-info-item {
            margin-bottom: var(--space-2);
        }
        
        .subscription-info-label {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .renewals-list {
            display: grid;
            gap: var(--space-3);
        }
        
        .renewal-item-edit {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--space-4);
            align-items: center;
        }
        
        .renewal-item-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .renewal-item-date {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }
        
        .renewal-item-date input {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        
        .renewal-item-date input[type="time"] {
            width: 120px;
        }
        
        .save-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Password Prompt -->
    <div id="passwordPrompt" class="password-prompt" style="display: none;">
        <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <input type="password" id="adminPassword" class="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
        <button class="password-btn" onclick="checkPassword()">–í–æ–π—Ç–∏</button>
        <p id="passwordError" style="color: var(--error); margin-top: var(--space-2); display: none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Debug Info (ALWAYS VISIBLE) -->
        <div id="debugInfo" style="display: block !important; background: #fff3cd !important; border: 3px solid #ffc107 !important; padding: 20px !important; margin: 20px 0 !important; border-radius: 8px !important; font-family: monospace !important; font-size: 14px !important; color: #000 !important; z-index: 9999 !important; position: relative !important;">
            <strong style="font-size: 16px;">üîç –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:</strong><br><br>
            <div id="debugText" style="line-height: 1.6;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>
        
        <div class="admin-header">
            <h1 class="admin-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã</h1>
            <div style="display: flex; gap: var(--space-3);">
                <a href="renewals.html" class="refresh-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-calendar-alt"></i> –ü—Ä–æ–¥–ª–µ–Ω–∏—è
                </a>
                <button class="refresh-btn" onclick="loadOrders()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>

        <div class="admin-stats" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>

        <div class="admin-filters">
            <div class="filter-group">
                <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/email</label>
                <input type="text" id="searchInput" placeholder="–ò–º—è –∏–ª–∏ email..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>–¢–æ–≤–∞—Ä</label>
                <select id="productFilter" onchange="filterOrders()">
                    <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    <option value="Chat-GPT Plus">Chat-GPT Plus</option>
                    <option value="Adobe Creative Cloud">Adobe Creative Cloud</option>
                    <option value="CapCut Pro">CapCut Pro</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select id="sortBy" onchange="sortOrders()">
                    <option value="date-desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="date-asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="amount-desc">–°—É–º–º–∞ (–±–æ–ª—å—à–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="amount-asc">–°—É–º–º–∞ (–º–µ–Ω—å—à–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="name-asc">–ò–º—è (–ê-–Ø)</option>
                    <option value="name-desc">–ò–º—è (–Ø-–ê)</option>
                </select>
            </div>
        </div>

        <div class="orders-table">
            <div class="table-header">
                <div>ID</div>
                <div>–ò–º—è</div>
                <div>Email</div>
                <div>–¢–æ–≤–∞—Ä</div>
                <div>–°—Ä–æ–∫</div>
                <div>–°—É–º–º–∞</div>
                <div>–î–∞—Ç–∞</div>
                <div>–í—Ä–µ–º—è</div>
                <div>–°—Ç–∞—Ç—É—Å</div>
            </div>
            <div id="ordersContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>
        </div>
    </div>

    <!-- Renewals Modal -->
    <div id="renewalsModal" class="renewals-modal">
        <div class="renewals-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</h2>
                <button class="modal-close" onclick="closeRenewalsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let adminPassword = '';

        // Initialize debug info immediately
        function initDebug() {
            const debugEl = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            if (debugEl && debugText) {
                debugEl.style.display = 'block';
                debugText.innerHTML = 'üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏...<br>';
            }
        }
        
        // Call immediately
        initDebug();
        
        // Check if password is in URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlPassword = urlParams.get('password');
        
        // Check localStorage for saved password
        const savedPassword = localStorage.getItem('admin_password');
        
        updateDebugInfo('üîç –ü—Ä–æ–≤–µ—Ä—è—é –ø–∞—Ä–æ–ª—å...');
        updateDebugInfo('   URL –ø–∞—Ä–∞–º–µ—Ç—Ä: ' + (urlPassword ? '–ï–°–¢–¨' : '–ù–ï–¢'));
        updateDebugInfo('   –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å: ' + (savedPassword ? '–ï–°–¢–¨' : '–ù–ï–¢'));
        
        if (urlPassword) {
            adminPassword = urlPassword;
            localStorage.setItem('admin_password', urlPassword); // Save to localStorage
            updateDebugInfo('‚úÖ –ü–∞—Ä–æ–ª—å –ø–æ–ª—É—á–µ–Ω –∏–∑ URL: ' + urlPassword.substring(0, 3) + '***');
            document.getElementById('passwordPrompt').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            setTimeout(() => loadOrders(), 100);
        } else if (savedPassword) {
            adminPassword = savedPassword;
            updateDebugInfo('‚úÖ –ü–∞—Ä–æ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ' + savedPassword.substring(0, 3) + '***');
            document.getElementById('passwordPrompt').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            setTimeout(() => loadOrders(), 100);
        } else {
            updateDebugInfo('‚ö†Ô∏è –ü–∞—Ä–æ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥');
            updateDebugInfo('üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å ?password=2728276 –≤ URL');
            document.getElementById('passwordPrompt').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('adminPassword').value;
            if (!input || input.trim() === '') {
                document.getElementById('passwordError').textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }
            
            adminPassword = input.trim();
            localStorage.setItem('admin_password', adminPassword);
            
            // Try to load orders with this password
            loadOrders();
        }

        function updateDebugInfo(text) {
            const debugEl = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            console.log('üîç DEBUG:', text); // Also log to console
            if (debugEl && debugText) {
                debugText.innerHTML += text + '<br>';
                debugEl.style.display = 'block';
                debugEl.style.background = '#fff3cd';
                debugEl.style.border = '2px solid #ffc107';
                debugEl.style.padding = '15px';
                debugEl.style.margin = '15px 0';
            } else {
                console.error('‚ùå Debug elements not found!', { debugEl, debugText });
            }
        }
        
        function loadOrders() {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
            
            // Clear debug info
            const debugText = document.getElementById('debugText');
            if (debugText) debugText.innerHTML = '';
            updateDebugInfo('üîê –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É –∑–∞–∫–∞–∑–æ–≤...');
            
            // Debug: Log password being used
            const passwordStatus = adminPassword ? `‚úÖ –ü–∞—Ä–æ–ª—å –µ—Å—Ç—å (–¥–ª–∏–Ω–∞: ${adminPassword.length})` : '‚ùå –ü–ê–†–û–õ–¨ –û–¢–°–£–¢–°–¢–í–£–ï–¢!';
            updateDebugInfo(passwordStatus);
            
            if (!adminPassword || adminPassword.trim() === '') {
                updateDebugInfo('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–∞—Ä–æ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω!');
                container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞: –ø–∞—Ä–æ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.</div>';
                document.getElementById('passwordPrompt').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
                return;
            }
            
            // Add timeout
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout')), 10000)
            );
            
            const apiUrl = `/api/admin/orders?password=${encodeURIComponent(adminPassword)}`;
            updateDebugInfo('üì° –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ API...');
            updateDebugInfo('   URL: /api/admin/orders?password=***');
            
            Promise.race([
                fetch(apiUrl),
                timeoutPromise
            ])
                .then(res => {
                    updateDebugInfo(`üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: —Å—Ç–∞—Ç—É—Å ${res.status} ${res.statusText}`);
                    
                    if (res.status === 401) {
                        updateDebugInfo('‚ùå –û–®–ò–ë–ö–ê: –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                        document.getElementById('passwordPrompt').style.display = 'block';
                        document.getElementById('adminPanel').style.display = 'none';
                        document.getElementById('passwordError').style.display = 'block';
                        document.getElementById('passwordError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å: 2728276';
                        throw new Error('Unauthorized');
                    }
                    if (!res.ok) {
                        updateDebugInfo(`‚ùå –û–®–ò–ë–ö–ê HTTP: ${res.status} ${res.statusText}`);
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    updateDebugInfo('‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω—ã–π, —á–∏—Ç–∞—é –¥–∞–Ω–Ω—ã–µ...');
                    return res.json();
                })
                .then(data => {
                    updateDebugInfo('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã!');
                    updateDebugInfo(`   success: ${data.success}`);
                    updateDebugInfo(`   orders count: ${data.orders ? data.orders.length : 0}`);
                    updateDebugInfo(`   total: ${data.total || 0}`);
                    
                    if (data.success) {
                        allOrders = data.orders || [];
                        updateDebugInfo(`üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${allOrders.length}`);
                        
                        if (allOrders.length > 0) {
                            updateDebugInfo(`‚úÖ –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω: ${allOrders[0].customer_name} (${allOrders[0].order_id})`);
                            
                            // CRITICAL: Display orders DIRECTLY first
                            displayOrders(allOrders);
                            updateDebugInfo('‚úÖ displayOrders –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é');
                            
                            // Update stats
                            updateStats(allOrders);
                            updateDebugInfo('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                            
                            // Also call sortOrdersList (it calls displayOrders again)
                            sortOrdersList(allOrders);
                            updateDebugInfo('‚úÖ sortOrdersList –≤—ã–∑–≤–∞–Ω');
                            
                            // Triple-check after delay
                            setTimeout(() => {
                                const container = document.getElementById('ordersContainer');
                                if (container) {
                                    const html = container.innerHTML;
                                    if (!html || html.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω—ã') || html.includes('–ó–∞–≥—Ä—É–∑–∫–∞')) {
                                        updateDebugInfo('‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—É—Å—Ç! –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é...');
                                        displayOrders(allOrders);
                                    }
                                }
                            }, 1000);
                        } else {
                            updateDebugInfo('‚ö†Ô∏è –í –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)');
                            displayOrders([]);
                            updateStats([]);
                        }
                        document.getElementById('passwordPrompt').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                    } else {
                        updateDebugInfo(`‚ùå API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                        container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ API: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';
                    }
                })
                .catch(err => {
                    updateDebugInfo(`‚ùå –û–®–ò–ë–ö–ê: ${err.message}`);
                    container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ' + err.message + '</div>';
                });
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersContainer');
            
            if (!container) {
                console.error('‚ùå Container not found!');
                updateDebugInfo('‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ordersContainer –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            if (orders.length === 0) {
                container.innerHTML = '<div class="loading">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                updateDebugInfo('‚ö†Ô∏è displayOrders –≤—ã–∑–≤–∞–Ω —Å –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º');
                return;
            }
            
            updateDebugInfo(`üìã displayOrders –≤—ã–∑–≤–∞–Ω —Å ${orders.length} –∑–∞–∫–∞–∑–∞–º–∏`);
            
            try {
                const html = orders.map(order => {
                    // Use first subscription_id for renewals modal if available
                    const subscriptionId = order.subscription_ids ? order.subscription_ids.split(',')[0] : order.id;
                    return `
                    <div class="table-row" onclick="openRenewalsModal(${subscriptionId})">
                        <div class="table-cell">${order.order_id || order.id || 'N/A'}</div>
                        <div class="table-cell" data-label="–ò–º—è">${order.customer_name || ''}</div>
                        <div class="table-cell" data-label="Email">${order.customer_email || ''}</div>
                        <div class="table-cell" data-label="–¢–æ–≤–∞—Ä">${order.product_name || ''}</div>
                        <div class="table-cell" data-label="–ö–æ–ª-–≤–æ">${order.items_count || 1}</div>
                        <div class="table-cell" data-label="–°—É–º–º–∞">${order.amount_formatted || (order.amount ? order.amount.toLocaleString('ru-RU') + ' ‚ÇΩ' : '0 ‚ÇΩ')}</div>
                        <div class="table-cell" data-label="–î–∞—Ç–∞">${order.purchase_date_formatted || ''}</div>
                        <div class="table-cell" data-label="–í—Ä–µ–º—è">${order.purchase_time || ''}</div>
                        <div class="table-cell" data-label="–°—Ç–∞—Ç—É—Å">
                            <span class="status-badge ${order.is_active ? 'status-active' : 'status-inactive'}">
                                ${order.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </div>
                    </div>
                `;
                }).join('');
                
                container.innerHTML = html;
                updateDebugInfo(`‚úÖ HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (${html.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            } catch (error) {
                console.error('Error in displayOrders:', error);
                updateDebugInfo(`‚ùå –û–®–ò–ë–ö–ê –≤ displayOrders: ${error.message}`);
                container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤: ' + error.message + '</div>';
            }
        }

        function updateStats(orders) {
            const total = orders.length;
            const totalAmount = orders.reduce((sum, o) => sum + (o.amount || 0), 0);
            const active = orders.filter(o => o.is_active).length;
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(o => o.purchase_date && o.purchase_date.startsWith(today)).length;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalAmount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${active}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${todayOrders}</div>
                    <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
            `;
        }

        let currentSort = 'date-desc';
        
        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const product = document.getElementById('productFilter').value;
            
            let filtered = allOrders.filter(order => {
                const matchSearch = !search || 
                    order.customer_name.toLowerCase().includes(search) ||
                    order.customer_email.toLowerCase().includes(search);
                
                const matchProduct = !product || order.product_name === product;
                
                return matchSearch && matchProduct;
            });
            
            // Apply sorting
            sortOrdersList(filtered);
        }
        
        function sortOrders() {
            currentSort = document.getElementById('sortBy').value;
            filterOrders();
        }
        
        function sortOrdersList(orders) {
            const sorted = [...orders].sort((a, b) => {
                switch(currentSort) {
                    case 'date-desc':
                        return new Date(b.purchase_date) - new Date(a.purchase_date);
                    case 'date-asc':
                        return new Date(a.purchase_date) - new Date(b.purchase_date);
                    case 'amount-desc':
                        return (b.amount || 0) - (a.amount || 0);
                    case 'amount-asc':
                        return (a.amount || 0) - (b.amount || 0);
                    case 'name-asc':
                        return a.customer_name.localeCompare(b.customer_name, 'ru');
                    case 'name-desc':
                        return b.customer_name.localeCompare(a.customer_name, 'ru');
                    default:
                        return 0;
                }
            });
            
            displayOrders(sorted);
        }

        // Allow Enter key in password input
        document.getElementById('adminPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Renewals Modal
        function openRenewalsModal(subscriptionId) {
            const modal = document.getElementById('renewalsModal');
            const content = document.getElementById('modalContent');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–π...</div>';
            
            fetch(`/api/admin/subscription/${subscriptionId}/renewals?password=${encodeURIComponent(adminPassword)}`)
                .then(res => {
                    if (res.status === 401) {
                        content.innerHTML = '<div class="error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>';
                        throw new Error('Unauthorized');
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        displayRenewalsModal(data.subscription, data.reminders);
                    }
                })
                .catch(err => {
                    console.error('Error loading renewals:', err);
                    if (!err.message.includes('Unauthorized')) {
                        content.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–π</div>';
                    }
                });
        }

        function closeRenewalsModal() {
            document.getElementById('renewalsModal').classList.remove('active');
        }

        function displayRenewalsModal(subscription, reminders) {
            const content = document.getElementById('modalContent');
            
            const subscriptionInfo = `
                <div class="subscription-info">
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–ö–ª–∏–µ–Ω—Ç:</span> ${subscription.customer_name}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">Email:</span> ${subscription.customer_email}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–¢–æ–≤–∞—Ä:</span> ${subscription.product_name}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–°—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏:</span> ${subscription.subscription_months} ${subscription.subscription_months === 1 ? '–º–µ—Å—è—Ü' : subscription.subscription_months >= 2 && subscription.subscription_months <= 4 ? '–º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü–µ–≤'}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏:</span> ${subscription.purchase_date_formatted}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">Order ID:</span> ${subscription.order_id || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </div>
                </div>
            `;
            
            if (reminders.length === 0) {
                content.innerHTML = subscriptionInfo + '<div class="empty">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            const renewalsList = reminders.map(reminder => {
                const reminderDate = new Date(reminder.reminder_date);
                const dateStr = reminderDate.toISOString().split('T')[0];
                const timeStr = reminderDate.toTimeString().slice(0, 5);
                
                const reminderTypeText = reminder.reminder_type === 'expiry' ? '–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏' :
                    reminder.reminder_type.startsWith('renewal_') ? 
                    `–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (${reminder.reminder_type.match(/renewal_(\d+)months/)?.[1] || '?'} –º–µ—Å. –æ—Å—Ç–∞–ª–æ—Å—å)` :
                    reminder.reminder_type;
                
                return `
                    <div class="renewal-item-edit" data-reminder-id="${reminder.reminder_id}">
                        <div class="renewal-item-info">
                            <div style="font-weight: 600;">${reminderTypeText}</div>
                            <div style="font-size: 0.85rem; color: var(--gray-600);">
                                ${reminder.is_sent ? '‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏'}
                            </div>
                        </div>
                        <div class="renewal-item-date">
                            <input type="date" value="${dateStr}" id="date_${reminder.reminder_id}" onchange="updateReminderDate(${reminder.reminder_id})">
                            <input type="time" value="${timeStr}" id="time_${reminder.reminder_id}" onchange="updateReminderDate(${reminder.reminder_id})">
                        </div>
                        <button class="save-btn" id="save_${reminder.reminder_id}" onclick="saveReminderDate(${reminder.reminder_id})" style="display: none;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = subscriptionInfo + `
                <h3 style="margin-bottom: var(--space-4); font-size: 1.2rem; font-weight: 600;">–ü—Ä–æ–¥–ª–µ–Ω–∏—è (${reminders.length})</h3>
                <div class="renewals-list">
                    ${renewalsList}
                </div>
            `;
        }

        let pendingUpdates = {};

        function updateReminderDate(reminderId) {
            const dateInput = document.getElementById(`date_${reminderId}`);
            const timeInput = document.getElementById(`time_${reminderId}`);
            const saveBtn = document.getElementById(`save_${reminderId}`);
            
            const newDate = new Date(`${dateInput.value}T${timeInput.value}`);
            pendingUpdates[reminderId] = newDate.toISOString();
            saveBtn.style.display = 'block';
        }

        function saveReminderDate(reminderId) {
            const saveBtn = document.getElementById(`save_${reminderId}`);
            const newDate = pendingUpdates[reminderId];
            
            if (!newDate) {
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            fetch(`/api/admin/reminder/${reminderId}?password=${encodeURIComponent(adminPassword)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reminder_date: newDate
                })
            })
            .then(res => {
                if (res.status === 401) {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    throw new Error('Unauthorized');
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    saveBtn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    saveBtn.style.background = 'var(--success)';
                    delete pendingUpdates[reminderId];
                    setTimeout(() => {
                        saveBtn.style.display = 'none';
                        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        saveBtn.style.background = '';
                        saveBtn.disabled = false;
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('Error saving reminder:', err);
                saveBtn.textContent = '–û—à–∏–±–∫–∞';
                saveBtn.disabled = false;
                setTimeout(() => {
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }, 2000);
            });
        }

        // Close modal on outside click
        document.getElementById('renewalsModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRenewalsModal();
            }
        });
    </script>
</body>
</html>

