<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã</title>
    <link rel="stylesheet" href="styles.css?v=2.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            margin-top: var(--space-6);
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }
        
        .admin-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .stat-card {
            background: var(--white);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: var(--space-2);
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        .admin-filters {
            background: var(--white);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-4);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .filter-group label {
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .filter-group input,
        .filter-group select {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        
        .orders-table {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 60px 1fr 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
            font-size: 0.9rem;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 60px 1fr 1.5fr 1.5fr 1fr 1fr 1fr 1fr 1fr;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--gray-100);
            align-items: center;
            transition: background 0.2s;
        }
        
        .table-row {
            cursor: pointer;
        }
        
        .table-row:hover {
            background: var(--gray-50);
        }
        
        .table-cell {
            font-size: 0.9rem;
            color: var(--gray-700);
            /* –î–µ–ª–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é —Ä–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É: –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –æ–±—Ä–µ–∑–∫–∞ –∏ –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .order-id {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--primary);
        }
        
        .status-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-active {
            background: var(--success);
            color: white;
        }
        
        .status-inactive {
            background: var(--gray-300);
            color: var(--gray-700);
        }
        
        .loading {
            text-align: center;
            padding: var(--space-12);
            color: var(--gray-500);
        }
        
        .error {
            text-align: center;
            padding: var(--space-12);
            color: var(--error);
        }
        
        .refresh-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
        }
        
        .password-prompt {
            max-width: 400px;
            margin: 100px auto;
            padding: var(--space-8);
            background: var(--white);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
        }
        
        .password-input {
            width: 100%;
            padding: var(--space-3);
            margin: var(--space-4) 0;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 1rem;
        }
        
        .password-btn {
            width: 100%;
            padding: var(--space-3);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }
        
        @media (max-width: 968px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }
            
            .table-header {
                display: none;
            }
            
            .table-cell::before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: var(--gray-600);
            }

            /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–∞—ë–º —Ç–µ–∫—Å—Ç—É –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
            .table-cell {
                white-space: normal;
            }
        }
        
        /* Modal styles */
        .messages-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        
        .messages-modal.active {
            display: flex;
        }
        
        .messages-modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
        }
        
        .messages-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .message-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .message-text {
            margin-bottom: var(--space-3);
            color: var(--gray-700);
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .message-time {
            color: var(--gray-500);
            font-size: 0.85rem;
        }
        
        .message-replies {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--gray-200);
        }
        
        .reply-item {
            background: var(--white);
            border-left: 3px solid var(--primary);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            border-radius: var(--radius-sm);
        }
        
        .reply-form {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        
        .reply-input {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background: white;
            cursor: text;
            pointer-events: auto;
            z-index: 1;
            position: relative;
        }
        
        .reply-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: -2px;
            border-color: var(--primary);
        }
        
        .reply-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .reply-btn:hover {
            opacity: 0.9;
        }
        
        .reply-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .renewals-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        
        .renewals-modal.active {
            display: flex;
        }
        
        .renewals-modal-content {
            background: var(--white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--gray-200);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
            padding: var(--space-2);
        }
        
        .modal-close:hover {
            color: var(--gray-900);
        }
        
        .subscription-info {
            background: var(--gray-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-6);
        }
        
        .subscription-info-item {
            margin-bottom: var(--space-2);
        }
        
        .subscription-info-label {
            font-weight: 600;
            color: var(--gray-700);
        }
        
        .renewals-list {
            display: grid;
            gap: var(--space-3);
        }
        
        .renewal-item-edit {
            background: var(--white);
            border: 1px solid var(--gray-200);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: var(--space-4);
            align-items: center;
        }
        
        .renewal-item-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .renewal-item-date {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }
        
        .renewal-item-date input {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }
        
        .renewal-item-date input[type="time"] {
            width: 120px;
        }
        
        .save-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Password Prompt -->
    <div id="passwordPrompt" class="password-prompt" style="display: none;">
        <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
        <input type="password" id="adminPassword" class="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
        <button class="password-btn" onclick="checkPassword()">–í–æ–π—Ç–∏</button>
        <p id="passwordError" style="color: var(--error); margin-top: var(--space-2); display: none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</p>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Debug Info (ALWAYS VISIBLE) -->
        <div id="debugInfo" style="display: block !important; background: #fff3cd !important; border: 3px solid #ffc107 !important; padding: 20px !important; margin: 20px 0 !important; border-radius: 8px !important; font-family: monospace !important; font-size: 14px !important; color: #000 !important; z-index: 9999 !important; position: relative !important;">
            <strong style="font-size: 16px;">üîç –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø:</strong><br><br>
            <div id="debugText" style="line-height: 1.6;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>
        
        <div class="admin-header">
            <h1 class="admin-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ó–∞–∫–∞–∑—ã</h1>
            <div style="display: flex; gap: var(--space-3);">
                <a href="renewals.html" class="refresh-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-calendar-alt"></i> –ü—Ä–æ–¥–ª–µ–Ω–∏—è
                </a>
                <button class="refresh-btn" onclick="openMessagesModal()" style="display: inline-flex; align-items: center; gap: var(--space-2);">
                    <i class="fas fa-comments"></i> –°–æ–æ–±—â–µ–Ω–∏—è
                </button>
                <button class="refresh-btn" onclick="loadOrders()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>

        <div class="admin-stats" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>

        <div class="admin-filters">
            <div class="filter-group">
                <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/email</label>
                <input type="text" id="searchInput" placeholder="–ò–º—è –∏–ª–∏ email..." oninput="filterOrders()">
            </div>
            <div class="filter-group">
                <label>–¢–æ–≤–∞—Ä</label>
                <select id="productFilter" onchange="filterOrders()">
                    <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                    <option value="Chat-GPT Plus">Chat-GPT Plus</option>
                    <option value="Adobe Creative Cloud">Adobe Creative Cloud</option>
                    <option value="CapCut Pro">CapCut Pro</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select id="sortBy" onchange="sortOrders()">
                    <option value="date-desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="date-asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="amount-desc">–°—É–º–º–∞ (–±–æ–ª—å—à–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="amount-asc">–°—É–º–º–∞ (–º–µ–Ω—å—à–µ —Å–Ω–∞—á–∞–ª–∞)</option>
                    <option value="name-asc">–ò–º—è (–ê-–Ø)</option>
                    <option value="name-desc">–ò–º—è (–Ø-–ê)</option>
                </select>
            </div>
        </div>

        <div class="orders-table">
            <div class="table-header">
                <div>ID</div>
                <div>–ò–º—è</div>
                <div>Email</div>
                <div>–¢–æ–≤–∞—Ä</div>
                <div>–°—Ä–æ–∫</div>
                <div>–°—É–º–º–∞</div>
                <div>–î–∞—Ç–∞</div>
                <div>–í—Ä–µ–º—è</div>
                <div>–°—Ç–∞—Ç—É—Å</div>
            </div>
            <div id="ordersContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messagesModal" class="messages-modal">
        <div class="messages-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h2>
                <button class="modal-close" onclick="closeMessagesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="messages-list" id="messagesList">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
                </div>
            </div>
        </div>
    </div>

    <!-- Renewals Modal -->
    <div id="renewalsModal" class="renewals-modal">
        <div class="renewals-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</h2>
                <button class="modal-close" onclick="closeRenewalsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalContent">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let adminPassword = '';

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–æ–ª—å: –∏–∑ URL –∏–ª–∏ –∏–∑ localStorage (–µ—Å–ª–∏ —É–∂–µ –≤–≤–æ–¥–∏–ª–∏ —Ä–∞–Ω–µ–µ)
        const urlParams = new URLSearchParams(window.location.search);
        const urlPassword = urlParams.get('password');
        const savedPassword = localStorage.getItem('admin_password');
        
        // –ë–û–õ–¨–®–ï –ù–ò–ö–ê–ö–û–ì–û –î–ï–§–û–õ–¢–ù–û–ì–û –ü–ê–†–û–õ–Ø: —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π –≤–≤–æ–¥ –∏–ª–∏ ?password=...
        adminPassword = urlPassword || savedPassword || '';
        
        if (adminPassword) {
            localStorage.setItem('admin_password', adminPassword);
            document.getElementById('passwordPrompt').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Update stats (–±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤)
            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">1</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">29 700 ‚ÇΩ</div>
                        <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">1</div>
                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                `;
            }
            
            // Load orders from API (will update stats automatically)
            console.log('‚úÖ Password accepted, loading orders...');
            loadOrders();
        } else {
            // –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ/–ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞
            document.getElementById('passwordPrompt').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
        }

        function checkPassword() {
            const input = document.getElementById('adminPassword').value.trim();
            const errorEl = document.getElementById('passwordError');
            
            if (!input) {
                if (errorEl) {
                    errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                    errorEl.style.display = 'block';
                }
                return;
            }
            
            adminPassword = input;
            localStorage.setItem('admin_password', adminPassword);
            if (errorEl) errorEl.style.display = 'none';
            document.getElementById('passwordPrompt').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Load orders from database after password check
            loadOrders();
        }

        function updateDebugInfo(text) {
            const debugEl = document.getElementById('debugInfo');
            const debugText = document.getElementById('debugText');
            console.log('üîç DEBUG:', text); // Also log to console
            if (debugEl && debugText) {
                debugText.innerHTML += text + '<br>';
                debugEl.style.display = 'block';
                debugEl.style.background = '#fff3cd';
                debugEl.style.border = '2px solid #ffc107';
                debugEl.style.padding = '15px';
                debugEl.style.margin = '15px 0';
            } else {
                console.error('‚ùå Debug elements not found!', { debugEl, debugText });
            }
        }
        
        function loadOrders() {
            console.log('üîç loadOrders() called');
            const container = document.getElementById('ordersContainer');
            if (!container) {
                console.error('‚ùå Container not found!');
                setTimeout(loadOrders, 500); // Retry
                return;
            }
            
            if (!adminPassword) {
                console.warn('‚ö†Ô∏è No admin password set, showing prompt');
                document.getElementById('passwordPrompt').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
                return;
            }
            
            console.log('‚úÖ Container found, loading orders...');
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>';
            
            const apiUrl = `/api/admin/orders?password=${encodeURIComponent(adminPassword)}`;
            console.log('üì° Loading orders from:', apiUrl);
            console.log('üîë Using password:', adminPassword ? '***' : 'NOT SET');
            
            fetch(apiUrl)
                .then(res => {
                    console.log('üì• Response status:', res.status);
                    console.log('üì• Response ok:', res.ok);
                    if (res.status === 401) {
                        console.error('‚ùå Unauthorized - wrong password');
                        document.getElementById('passwordPrompt').style.display = 'block';
                        document.getElementById('adminPanel').style.display = 'none';
                        throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    }
                    if (!res.ok) {
                        console.error('‚ùå HTTP error:', res.status);
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('‚úÖ Data received:', data);
                    console.log('‚úÖ Success:', data.success);
                    console.log('‚úÖ Orders array:', data.orders);
                    console.log('‚úÖ Orders count:', data.orders ? data.orders.length : 0);
                    console.log('‚úÖ Total:', data.total);
                    
                    if (data.success && data.orders && data.orders.length > 0) {
                        console.log('‚úÖ Found orders, displaying...');
                        allOrders = data.orders;
                        displayOrders(allOrders);
                        updateStats(allOrders);
                    } else {
                        console.warn('‚ö†Ô∏è No orders found in response');
                        console.warn('   success:', data.success);
                        console.warn('   orders:', data.orders);
                        container.innerHTML = '<div class="loading">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        updateStats([]);
                    }
                })
                .catch(err => {
                    console.error('‚ùå Error loading orders:', err);
                    console.error('   Error message:', err.message);
                    console.error('   Error stack:', err.stack);
                    container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞: ' + err.message + '</div>';
                });
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersContainer');
            if (!container) {
                console.error('Container not found!');
                return;
            }
            
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading">–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            console.log('Displaying orders:', orders);
            
            const html = orders.map(order => {
                const orderId = order.order_id || `ID-${order.id}`;
                const customerName = order.customer_name || '';
                const customerEmail = order.customer_email || '';
                const productName = order.product_name || '';
                const duration = order.duration_text || `${order.subscription_months || 1} –º–µ—Å.`;
                const amount = order.amount_formatted || (order.amount ? order.amount.toLocaleString('ru-RU') + ' ‚ÇΩ' : '0 ‚ÇΩ');
                const date = order.purchase_date_formatted || '';
                const time = order.purchase_time || '';
                const isActive = order.is_active === 1 || order.is_active === true;
                
                return `
                <div class="table-row"
                     data-order-id="${orderId}"
                     data-product-id="${order.product_id || ''}"
                     data-json-order-id="${order.id || ''}"
                     data-email="${customerEmail}"
                     onclick="openRenewalsModalFromRow(this)">
                    <div class="table-cell">${orderId}</div>
                    <div class="table-cell" data-label="–ò–º—è">${customerName}</div>
                    <div class="table-cell" data-label="Email">${customerEmail}</div>
                    <div class="table-cell" data-label="–¢–æ–≤–∞—Ä">${productName}</div>
                    <div class="table-cell" data-label="–°—Ä–æ–∫">${duration}</div>
                    <div class="table-cell" data-label="–°—É–º–º–∞">${amount}</div>
                    <div class="table-cell" data-label="–î–∞—Ç–∞">${date}</div>
                    <div class="table-cell" data-label="–í—Ä–µ–º—è">${time}</div>
                    <div class="table-cell" data-label="–°—Ç–∞—Ç—É—Å">
                        <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                            ${isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = html;
            console.log('Orders displayed, HTML length:', html.length);
        }

        function updateStats(orders) {
            const total = orders.length;
            const totalAmount = orders.reduce((sum, o) => sum + (o.amount || 0), 0);
            const active = orders.filter(o => o.is_active === 1 || o.is_active === true).length;
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = orders.filter(o => o.purchase_date && o.purchase_date.startsWith(today)).length;
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalAmount.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    <div class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${active}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${todayOrders}</div>
                    <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
            `;
        }

        let currentSort = 'date-desc';
        
        function filterOrders() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const product = document.getElementById('productFilter').value;
            
            let filtered = allOrders.filter(order => {
                const matchSearch = !search || 
                    order.customer_name.toLowerCase().includes(search) ||
                    order.customer_email.toLowerCase().includes(search);
                
                const matchProduct = !product || order.product_name === product;
                
                return matchSearch && matchProduct;
            });
            
            // Apply sorting
            sortOrdersList(filtered);
        }
        
        function sortOrders() {
            currentSort = document.getElementById('sortBy').value;
            filterOrders();
        }
        
        function sortOrdersList(orders) {
            const sorted = [...orders].sort((a, b) => {
                switch(currentSort) {
                    case 'date-desc':
                        return new Date(b.purchase_date) - new Date(a.purchase_date);
                    case 'date-asc':
                        return new Date(a.purchase_date) - new Date(b.purchase_date);
                    case 'amount-desc':
                        return (b.amount || 0) - (a.amount || 0);
                    case 'amount-asc':
                        return (a.amount || 0) - (b.amount || 0);
                    case 'name-asc':
                        return a.customer_name.localeCompare(b.customer_name, 'ru');
                    case 'name-desc':
                        return b.customer_name.localeCompare(a.customer_name, 'ru');
                    default:
                        return 0;
                }
            });
            
            displayOrders(sorted);
        }

        // Allow Enter key in password input
        document.getElementById('adminPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // Renewals Modal
        function openRenewalsModalFromRow(rowEl) {
            if (!rowEl) return;
            
            const orderId = rowEl.getAttribute('data-order-id') || '';
            const productId = rowEl.getAttribute('data-product-id') || '';
            const email = rowEl.getAttribute('data-email') || '';
            const jsonOrderId = rowEl.getAttribute('data-json-order-id') || '';
            
            openRenewalsModal(orderId, productId, email, jsonOrderId);
        }

        function openRenewalsModal(orderId, productId, email, jsonOrderId) {
            const modal = document.getElementById('renewalsModal');
            const content = document.getElementById('modalContent');
            
            modal.classList.add('active');
            content.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–π...</div>';
            
            const params = new URLSearchParams({
                order_id: orderId || '',
                product_id: productId || '',
                email: email || '',
                json_order_id: jsonOrderId || '',
                password: adminPassword || ''
            });
            
            fetch(`/api/admin/order-renewals?${params.toString()}`)
                .then(res => {
                    if (res.status === 401) {
                        content.innerHTML = '<div class="error">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>';
                        throw new Error('Unauthorized');
                    }
                    if (res.status === 404) {
                        content.innerHTML = '<div class="error">–î–ª—è —ç—Ç–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–æ–¥–ø–∏—Å–∫–∞/–ø—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                        throw new Error('Subscription not found');
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success && Array.isArray(data.subscriptions)) {
                        displayRenewalsModalForSubscriptions(data.subscriptions);
                    } else if (data.success && data.subscription) {
                        // —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                        displayRenewalsModalForSubscriptions([{
                            ...data.subscription,
                            reminders: data.reminders || []
                        }]);
                    } else {
                        content.innerHTML = '<div class="error">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    }
                })
                .catch(err => {
                    console.error('Error loading renewals:', err);
                    if (!err.message.includes('Unauthorized')) {
                        content.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–π</div>';
                    }
                });
        }

        function closeRenewalsModal() {
            document.getElementById('renewalsModal').classList.remove('active');
        }

        function displayRenewalsModalForSubscriptions(subscriptions) {
            const content = document.getElementById('modalContent');
            
            if (!subscriptions || subscriptions.length === 0) {
                content.innerHTML = '<div class="empty">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            // –ë–µ—Ä—ë–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∑–∞–∫–∞–∑—É –∏–∑ –ø–µ—Ä–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
            const base = subscriptions[0];
            const header = `
                <div class="subscription-info" style="margin-bottom: var(--space-6);">
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–ö–ª–∏–µ–Ω—Ç:</span> ${base.customer_name}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">Email:</span> ${base.customer_email}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">Order ID:</span> ${base.order_id || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </div>
                </div>
            `;
            
            const blocks = subscriptions.map((subscription, index) => {
                const title = `
                    <h3 style="margin-bottom: var(--space-3); font-size: 1.1rem; font-weight: 600;">
                        –¢–æ–≤–∞—Ä ${subscriptions.length > 1 ? index + 1 : ''}: ${subscription.product_name}
                    </h3>
                `;
                
                const subInfo = `
                    <div class="subscription-info" style="margin-bottom: var(--space-4);">
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–°—Ä–æ–∫ –ø–æ–¥–ø–∏—Å–∫–∏:</span> ${subscription.subscription_months} ${subscription.subscription_months === 1 ? '–º–µ—Å—è—Ü' : subscription.subscription_months >= 2 && subscription.subscription_months <= 4 ? '–º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü–µ–≤'}
                    </div>
                    <div class="subscription-info-item">
                        <span class="subscription-info-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏:</span> ${subscription.purchase_date_formatted}
                    </div>
                </div>
            `;
                
                const reminders = subscription.reminders || [];
            
            if (reminders.length === 0) {
                    return title + subInfo + '<div class="empty">–ü—Ä–æ–¥–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
            
            const renewalsList = reminders.map(reminder => {
                const reminderDate = new Date(reminder.reminder_date);
                const dateStr = reminderDate.toISOString().split('T')[0];
                const hours = String(reminderDate.getUTCHours()).padStart(2, '0');
                const minutes = String(reminderDate.getUTCMinutes()).padStart(2, '0');
                const timeStr = `${hours}:${minutes}`;
                
                const reminderTypeText = reminder.reminder_type === 'expiry' ? '–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏' :
                    reminder.reminder_type.startsWith('renewal_') ? 
                    `–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (${reminder.reminder_type.match(/renewal_(\d+)months/)?.[1] || '?'} –º–µ—Å. –æ—Å—Ç–∞–ª–æ—Å—å)` :
                    reminder.reminder_type;
                
                return `
                    <div class="renewal-item-edit" data-reminder-id="${reminder.reminder_id}">
                        <div class="renewal-item-info">
                            <div style="font-weight: 600;">${reminderTypeText}</div>
                            <div style="font-size: 0.85rem; color: var(--gray-600);">
                                ${reminder.is_sent ? '‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏'}
                            </div>
                        </div>
                        <div class="renewal-item-date">
                            <input type="date" value="${dateStr}" id="date_${reminder.reminder_id}" onchange="updateReminderDate(${reminder.reminder_id})">
                            <input type="time" value="${timeStr}" id="time_${reminder.reminder_id}" onchange="updateReminderDate(${reminder.reminder_id})">
                        </div>
                        <button class="save-btn" id="save_${reminder.reminder_id}" onclick="saveReminderDate(${reminder.reminder_id})" style="display: none;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                `;
            }).join('');
            
                return title + subInfo + `
                    <h4 style="margin-bottom: var(--space-3); font-size: 1rem; font-weight: 600;">–ü—Ä–æ–¥–ª–µ–Ω–∏—è (${reminders.length})</h4>
                    <div class="renewals-list" style="margin-bottom: var(--space-6);">
                    ${renewalsList}
                </div>
            `;
            }).join('<hr style="margin: var(--space-4) 0; border: none; border-top: 1px solid var(--gray-200);">');
            
            content.innerHTML = header + blocks;
        }

        let pendingUpdates = {};

        function updateReminderDate(reminderId) {
            const dateInput = document.getElementById(`date_${reminderId}`);
            const timeInput = document.getElementById(`time_${reminderId}`);
            const saveBtn = document.getElementById(`save_${reminderId}`);
            
            // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ UTC, —á—Ç–æ–±—ã –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å —Ç–æ—á–Ω–æ –∫–∞–∫ –≤–≤–µ–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            const [year, month, day] = dateInput.value.split('-').map(Number);
            const [hours, minutes] = timeInput.value.split(':').map(Number);
            
            // –°–æ–∑–¥–∞–µ–º Date –æ–±—ä–µ–∫—Ç –≤ UTC —Å –≤–≤–µ–¥–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
            const newDate = new Date(Date.UTC(year, month - 1, day, hours, minutes, 0, 0));
            pendingUpdates[reminderId] = newDate.toISOString();
            saveBtn.style.display = 'block';
        }

        function saveReminderDate(reminderId) {
            const saveBtn = document.getElementById(`save_${reminderId}`);
            const newDate = pendingUpdates[reminderId];
            
            if (!newDate) {
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            fetch(`/api/admin/reminder/${reminderId}?password=${encodeURIComponent(adminPassword)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reminder_date: newDate
                })
            })
            .then(res => {
                if (res.status === 401) {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    throw new Error('Unauthorized');
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    saveBtn.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    saveBtn.style.background = 'var(--success)';
                    delete pendingUpdates[reminderId];
                    setTimeout(() => {
                        saveBtn.style.display = 'none';
                        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                        saveBtn.style.background = '';
                        saveBtn.disabled = false;
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('Error saving reminder:', err);
                saveBtn.textContent = '–û—à–∏–±–∫–∞';
                saveBtn.disabled = false;
                setTimeout(() => {
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }, 2000);
            });
        }

        // Close modal on outside click
        document.getElementById('renewalsModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRenewalsModal();
            }
        });
        
        // Messages Modal - make it globally accessible
        window.openMessagesModal = function() {
            console.log('Opening messages modal...');
            const modal = document.getElementById('messagesModal');
            const list = document.getElementById('messagesList');
            
            if (!modal) {
                console.error('Messages modal not found!');
                alert('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            if (!list) {
                console.error('Messages list not found!');
                alert('–°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            console.log('Modal found, opening...');
            modal.classList.add('active');
            list.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
            
            loadSupportMessages();
        };
        
        // Also keep the regular function for backwards compatibility
        function openMessagesModal() {
            window.openMessagesModal();
        }
        
        function closeMessagesModal() {
            document.getElementById('messagesModal').classList.remove('active');
        }
        
        async function loadSupportMessages() {
            try {
                const response = await fetch('/api/admin/support-messages?password=' + encodeURIComponent(adminPassword));
                const data = await response.json();
                
                if (!data.success) {
                    document.getElementById('messagesList').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                    return;
                }
                
                const chats = data.chats || [];
                const replies = data.replies || {};
                
                if (chats.length === 0) {
                    document.getElementById('messagesList').innerHTML = '<div class="empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                    return;
                }
                
                let html = '';
                chats.forEach((chat, chatIndex) => {
                    const clientInfo = `–ö–ª–∏–µ–Ω—Ç #${chat.clientId} (IP: ${chat.clientIP})`;
                    html += `
                        <div class="chat-section" style="margin-bottom: var(--space-6); padding-bottom: var(--space-4); border-bottom: 2px solid var(--gray-300);">
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary); margin-bottom: var(--space-4);">
                                <i class="fas fa-user"></i> ${clientInfo}
                                <span style="font-size: 0.85rem; font-weight: 400; color: var(--gray-500); margin-left: var(--space-2);">
                                    (${chat.messages.length} ${chat.messages.length === 1 ? '—Å–æ–æ–±—â–µ–Ω–∏–µ' : chat.messages.length < 5 ? '—Å–æ–æ–±—â–µ–Ω–∏—è' : '—Å–æ–æ–±—â–µ–Ω–∏–π'})
                                </span>
                            </div>
                    `;
                    
                    chat.messages.forEach(msg => {
                        const messageReplies = replies[msg.messageId] || [];
                        const timestamp = new Date(msg.timestamp).toLocaleString('ru-RU');
                        
                        html += `
                            <div class="message-item" style="margin-bottom: var(--space-4);">
                                <div class="message-header">
                                    <strong>–°–æ–æ–±—â–µ–Ω–∏–µ #${msg.messageId}</strong>
                                    <span class="message-time">${timestamp}</span>
                                </div>
                                ${msg.hasImage && msg.imageFilename ? `
                                    <div class="message-image" style="margin-bottom: var(--space-3);">
                                        <img src="/uploads/support/${msg.imageFilename}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 100%; max-height: 400px; border-radius: var(--radius-md); border: 1px solid var(--gray-200);">
                                    </div>
                                ` : ''}
                                <div class="message-text">
                                    ${msg.message || (msg.hasImage ? '(—Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)' : '')}
                                </div>
                                ${messageReplies.length > 0 ? `
                                    <div class="message-replies">
                                        <strong style="display: block; margin-bottom: var(--space-2);">–û—Ç–≤–µ—Ç—ã:</strong>
                                        ${messageReplies.map(reply => `
                                            <div class="reply-item">
                                                <div>${reply.text}</div>
                                                <div class="message-time" style="margin-top: var(--space-1);">${new Date(reply.timestamp).toLocaleString('ru-RU')}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div class="reply-form">
                                    <input type="text" class="reply-input" id="replyInput_${msg.messageId}" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç..." onkeypress="if(event.key==='Enter') sendReply('${msg.messageId}')">
                                    <button class="reply-btn" onclick="sendReply('${msg.messageId}')">
                                        <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                document.getElementById('messagesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            }
        }
        
        async function sendReply(messageId) {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—è –≤–≤–æ–¥–∞
            const safeId = 'replyInput_' + messageId.replace(/[^a-zA-Z0-9_]/g, '_');
            const input = document.getElementById(safeId);
            
            if (!input) {
                console.error('Input field not found for messageId:', messageId, 'safeId:', safeId);
                alert('–û—à–∏–±–∫–∞: –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            const replyText = input.value.trim();
            
            if (!replyText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                return;
            }
            
            const button = input.nextElementSibling;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            try {
                const response = await fetch('/api/admin/support-reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messageId: messageId,
                        replyText: replyText,
                        password: adminPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    input.value = '';
                    loadSupportMessages(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        document.getElementById('messagesModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeMessagesModal();
            }
        });
    </script>
</body>
</html>

