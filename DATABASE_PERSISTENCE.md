# Защита базы данных от удаления на Render

## Проблема
На Render Free плане база данных SQLite может удаляться при деплое, если она не находится в правильном месте.

## Решение

### 1. Использование персистентного пути
База данных настроена на использование пути `/opt/render/project/src/subscriptions.db`, который сохраняется между деплоями на Render.

### 2. Настройки в render.yaml
```yaml
envVars:
  - key: DATABASE_PATH
    value: /opt/render/project/src/subscriptions.db
```

### 3. Защита данных
- **WAL mode**: Включен для лучшей производительности и надежности
- **Synchronous FULL**: Все записи гарантированно сохраняются на диск
- **WAL checkpoint**: Принудительная синхронизация после каждой операции
- **Транзакции**: Использование транзакций для атомарности операций

### 4. Автоматическое восстановление
- При каждом запуске сервера проверяется наличие всех отзывов
- Если отзыв отсутствует, он автоматически восстанавливается из заказа

## Альтернативные решения

### Вариант 1: Render PostgreSQL (Рекомендуется для продакшена)
1. Создайте PostgreSQL базу данных на Render
2. Измените код для использования PostgreSQL вместо SQLite
3. База данных будет полностью персистентной

### Вариант 2: Railway
Railway имеет более надежное хранилище для Free плана:
1. Зайдите на https://railway.app
2. Создайте новый проект
3. Деплойте из GitHub репозитория
4. База данных будет сохраняться автоматически

### Вариант 3: Внешнее хранилище
Используйте внешнее облачное хранилище (S3, Google Cloud Storage) для бэкапа базы данных.

## Текущая конфигурация

База данных использует:
- Путь: `/opt/render/project/src/subscriptions.db` (на Render)
- Или: `./subscriptions.db` (локально)
- WAL mode: включен
- Synchronous: FULL
- Автоматический checkpoint после каждой операции

## Проверка

После деплоя проверьте логи:
1. Откройте панель Render
2. Перейдите в "Logs"
3. Найдите строки:
   - `✅ Database opened successfully at: /opt/render/project/src/subscriptions.db`
   - `✅ Database file exists: true`
   - `✅ WAL mode enabled`

Если база данных не сохраняется:
1. Проверьте, что переменная окружения `DATABASE_PATH` установлена
2. Проверьте логи на наличие ошибок
3. Рассмотрите переход на PostgreSQL или Railway

